name: Nuxt3 CI/CD to å®å¡”
on:
  push:
    branches: [master]  # ä»…mainåˆ†æ”¯è§¦å‘éƒ¨ç½²

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@master

      # 2. è®¾ç½®Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. ç™»å½•Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # 4. æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 5. éƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨ï¼ˆæ›¿æ¢å®¹å™¨é•œåƒï¼Œç»™æ­¥éª¤åŠ IDç”¨äºåˆ¤æ–­çŠ¶æ€ï¼‰
      - name: Deploy to å®å¡”æœåŠ¡å™¨
        id: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}  # æœåŠ¡å™¨IP
          username: ${{ secrets.SERVER_SSH_USER }}  # æœåŠ¡å™¨ç”¨æˆ·åï¼ˆå¦‚rootï¼‰
          key: ${{ secrets.SERVER_SSH_KEY }}  # SSHå¯†é’¥
          port: ${{ secrets.SERVER_SSH_PORT }}  # SSHç«¯å£ï¼ˆé»˜è®¤22ï¼‰
          script: |
            # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–æœ€æ–°é•œåƒ
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest
            
            # ç¬¬äºŒæ­¥ï¼šå®šä¹‰å®¹å™¨åï¼ˆå·²æŒ‡å®šä¸ºä½ çš„å®é™…å®¹å™¨åï¼‰
            CONTAINER_NAME="vigorbuysheet-docker"
            
            # ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™æ›¿æ¢é•œåƒå¹¶é‡å¯
            if docker ps -a --format "{{.Names}}" | grep -q "$CONTAINER_NAME"; then
              docker stop $CONTAINER_NAME
              docker container update --image ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest $CONTAINER_NAME
              docker start $CONTAINER_NAME
              echo "å®¹å™¨ $CONTAINER_NAME é•œåƒå·²æ›´æ–°å¹¶é‡å¯"
            else
              docker-compose up -d
              echo "å®¹å™¨ä¸å­˜åœ¨ï¼Œå·²åˆ›å»ºæ–°å®¹å™¨å¹¶å¯åŠ¨"
            fi
            
            # ç¬¬å››æ­¥ï¼šæ¸…ç†æ— ç”¨é•œåƒï¼ˆèŠ‚çœç©ºé—´ï¼‰
            docker system prune -f

      # 6. æ‰“åŒ…+éƒ¨ç½²æˆåŠŸåæ¨é€é£ä¹¦é€šçŸ¥ï¼ˆä»…æˆåŠŸæ—¶æ‰§è¡Œï¼‰
      - name: Send Feishu Success Notification
        if: steps.deploy.outcome == 'success'  # ä»…éƒ¨ç½²æ­¥éª¤æˆåŠŸæ—¶è§¦å‘
        env:
          # é£ä¹¦æœºå™¨äººWebhookï¼ˆéœ€æå‰æ·»åŠ åˆ°GitHub Secretsï¼Œå‘½åä¸ºFEISHU_WEBHOOKï¼‰
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          # Gitæ ¸å¿ƒä¿¡æ¯
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_ID: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          # éƒ¨ç½²ç›¸å…³ä¿¡æ¯
          SERVER_HOST: ${{ secrets.SERVER_SSH_HOST }}
          CONTAINER_NAME: "vigorbuysheet-docker"
          DOCKER_IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest
          # GitHub Actionæ—¥å¿—é“¾æ¥ï¼ˆæ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼‰
          ACTION_LOG_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # æ ¼å¼åŒ–çŸ­æäº¤IDï¼ˆå¦‚ abc1234ï¼Œæ›´æ˜“é˜…è¯»ï¼‰
          SHORT_COMMIT_ID=$(echo $COMMIT_ID | cut -c1-7)
          # éƒ¨ç½²å®Œæˆæ—¶é—´
          DEPLOY_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          
          # ç»„è£…é£ä¹¦å¯Œæ–‡æœ¬æ¶ˆæ¯ï¼ˆæ’ç‰ˆæ¸…æ™°ï¼Œå…³é”®ä¿¡æ¯åŠ è¶…é“¾æ¥ï¼‰
          FEISHU_MSG=$(cat << EOF
          {
            "msg_type": "post",
            "content": {
              "post": {
                "zh_cn": {
                  "title": "âœ… Nuxt3 æ‰“åŒ…éƒ¨ç½²æˆåŠŸ | å®å¡”æœåŠ¡å™¨",
                  "content": [
                    [{"tag":"text","text":"ğŸ“‹ é¡¹ç›®ï¼š${REPO_NAME}"}],
                    [{"tag":"text","text":"ğŸŒ¿ åˆ†æ”¯ï¼š${BRANCH_NAME}"}],
                    [{"tag":"text","text":"ğŸ”– æäº¤ç‰ˆæœ¬ï¼š"},{"tag":"a","text":"${SHORT_COMMIT_ID}","href":"https://github.com/${REPO_NAME}/commit/${COMMIT_ID}"}],
                    [{"tag":"text","text":"âœï¸ æäº¤è€…ï¼š${COMMIT_AUTHOR} | æäº¤è¯´æ˜ï¼š${COMMIT_MSG}"}],
                    [{"tag":"text","text":"ğŸ–¥ï¸ éƒ¨ç½²æœåŠ¡å™¨ï¼š${SERVER_HOST}"}],
                    [{"tag":"text","text":"ğŸ“¦ å®¹å™¨åï¼š${CONTAINER_NAME}"}],
                    [{"tag":"text","text":"ğŸ³ é•œåƒç‰ˆæœ¬ï¼š${DOCKER_IMAGE}"}],
                    [{"tag":"text","text":"ğŸ•’ éƒ¨ç½²å®Œæˆæ—¶é—´ï¼š${DEPLOY_TIME}"}],
                    [{"tag":"text","text":"ğŸ“ éƒ¨ç½²æ—¥å¿—ï¼š"},{"tag":"a","text":"æŸ¥çœ‹GitHub Actionæ—¥å¿—","href":"${ACTION_LOG_URL}"}]
                  ]
                }
              }
            }
          }
          EOF
          )
          
          # æ¨é€æ¶ˆæ¯åˆ°é£ä¹¦
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$FEISHU_MSG" \
            $FEISHU_WEBHOOK