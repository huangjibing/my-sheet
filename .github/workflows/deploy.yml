name: Nuxt3 CI/CD to å®å¡”
on:
  push:
    branches: [master]  # ä»…masteråˆ†æ”¯è§¦å‘éƒ¨ç½²

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@master

      # 2. è®¾ç½®Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. ç™»å½•Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # 4. æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 5. éƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨ï¼ˆç»™æ­¥éª¤åŠ IDï¼Œç”¨äºåˆ¤æ–­çŠ¶æ€ï¼‰
      - name: Deploy to å®å¡”æœåŠ¡å™¨
        id: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest
            docker-compose down || true
            docker-compose up -d
            docker system prune -f

      # 6. éƒ¨ç½²æˆåŠŸåæ¨é€é£ä¹¦é€šçŸ¥ï¼ˆä»…æˆåŠŸæ—¶æ‰§è¡Œï¼‰
      - name: Send Feishu Success Notification
        if: steps.deploy.outcome == 'success'  # ä»…éƒ¨ç½²æˆåŠŸæ—¶è§¦å‘
        env:
          # é£ä¹¦æœºå™¨äººWebhookï¼ˆéœ€æå‰æ·»åŠ åˆ°GitHub Secretsï¼Œå‘½åä¸ºFEISHU_WEBHOOKï¼‰
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          # Gitæ ¸å¿ƒä¿¡æ¯
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_ID: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          # éƒ¨ç½²ç›¸å…³ä¿¡æ¯
          SERVER_HOST: ${{ secrets.SERVER_SSH_HOST }}
          DOCKER_IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest
          # GitHub Actionæ—¥å¿—é“¾æ¥
          ACTION_LOG_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # æ ¼å¼åŒ–çŸ­æäº¤IDï¼ˆå¦‚ abc1234ï¼‰
          SHORT_COMMIT_ID=$(echo $COMMIT_ID | cut -c1-7)
          
          # ç»„è£…é£ä¹¦å¯Œæ–‡æœ¬æ¶ˆæ¯
          FEISHU_MSG=$(cat << EOF
          {
            "msg_type": "post",
            "content": {
              "post": {
                "zh_cn": {
                  "title": "âœ… Nuxt3 éƒ¨ç½²æˆåŠŸ | å®å¡”æœåŠ¡å™¨",
                  "content": [
                    [{"tag":"text","text":"ğŸ“‹ é¡¹ç›®ä¿¡æ¯ï¼š${REPO_NAME}"}],
                    [{"tag":"text","text":"ğŸŒ¿ éƒ¨ç½²åˆ†æ”¯ï¼š${BRANCH_NAME}"}],
                    [{"tag":"text","text":"ğŸ”– æäº¤ç‰ˆæœ¬ï¼š"},{"tag":"a","text":"${SHORT_COMMIT_ID}","href":"https://github.com/${REPO_NAME}/commit/${COMMIT_ID}"}],
                    [{"tag":"text","text":"âœï¸ æäº¤è€…ï¼š${COMMIT_AUTHOR} | æäº¤è¯´æ˜ï¼š${COMMIT_MSG}"}],
                    [{"tag":"text","text":"ğŸ–¥ï¸ éƒ¨ç½²æœåŠ¡å™¨ï¼š${SERVER_HOST}"}],
                    [{"tag":"text","text":"ğŸ³ é•œåƒç‰ˆæœ¬ï¼š${DOCKER_IMAGE}"}],
                    [{"tag":"text","text":"ğŸ“ éƒ¨ç½²æ—¥å¿—ï¼š"},{"tag":"a","text":"æŸ¥çœ‹GitHub Actionæ—¥å¿—","href":"${ACTION_LOG_URL}"}]
                  ]
                }
              }
            }
          }
          EOF
          )
          
          # æ¨é€æ¶ˆæ¯åˆ°é£ä¹¦
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$FEISHU_MSG" \
            $FEISHU_WEBHOOK