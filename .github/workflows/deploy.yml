name: Nuxt3 CI/CD to å®å¡”
on:
  push:
    branches: [master]  # ä»…mainåˆ†æ”¯è§¦å‘éƒ¨ç½²

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@master

      # 2. è®¾ç½®Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. ç™»å½•Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # 4. æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 5. éƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨ï¼ˆæ›¿æ¢å®¹å™¨é•œåƒï¼Œä¸é‡å»ºå®¹å™¨ï¼‰
      - name: Deploy to å®å¡”æœåŠ¡å™¨
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–æœ€æ–°é•œåƒ
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest
            
            # ç¬¬äºŒæ­¥ï¼šå®šä¹‰å®¹å™¨åï¼ˆéœ€æ›¿æ¢ä¸ºä½ å®é™…çš„å®¹å™¨åï¼Œå¯é€šè¿‡ docker ps æŸ¥çœ‹ï¼‰
            CONTAINER_NAME="vigorbuysheet-docker"  # æ”¹ä¸ºä½ çš„å®¹å™¨åï¼Œæ¯”å¦‚ docker-compose ä¸­å®šä¹‰çš„æœåŠ¡å
            
            # ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™æ›¿æ¢é•œåƒå¹¶é‡å¯
            if docker ps -a --format "{{.Names}}" | grep -q "$CONTAINER_NAME"; then
              # åœæ­¢å®¹å™¨ï¼ˆä¸åˆ é™¤ï¼‰
              docker stop $CONTAINER_NAME
              # æ›¿æ¢å®¹å™¨ä½¿ç”¨çš„é•œåƒï¼ˆæ ¸å¿ƒå‘½ä»¤ï¼š--force å¼ºåˆ¶æ›¿æ¢ï¼‰
              docker container update --image ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest $CONTAINER_NAME
              # é‡å¯å®¹å™¨ï¼ˆä¿ç•™åŸæœ‰é…ç½®ï¼šç½‘ç»œã€å·ã€ç«¯å£æ˜ å°„ç­‰ï¼‰
              docker start $CONTAINER_NAME
              echo "å®¹å™¨ $CONTAINER_NAME é•œåƒå·²æ›´æ–°å¹¶é‡å¯"
            else
              # å®¹å™¨ä¸å­˜åœ¨æ—¶ï¼Œæ‰ç”¨docker-composeåˆ›å»ºï¼ˆå…¼å®¹é¦–æ¬¡éƒ¨ç½²ï¼‰
              docker-compose up -d
              echo "å®¹å™¨ä¸å­˜åœ¨ï¼Œå·²åˆ›å»ºæ–°å®¹å™¨å¹¶å¯åŠ¨"
            fi
            
            # ç¬¬å››æ­¥ï¼šæ¸…ç†æ— ç”¨é•œåƒï¼ˆèŠ‚çœç©ºé—´ï¼‰
            docker system prune -f
       # 6. éƒ¨ç½²æˆåŠŸåæ¨é€é£ä¹¦é€šçŸ¥ï¼ˆä»…æˆåŠŸæ—¶æ‰§è¡Œï¼‰
      - name: Send Feishu Success Notification
        if: steps.deploy.outcome == 'success'  # ä»…éƒ¨ç½²æˆåŠŸæ—¶è§¦å‘
        env:
          # é£ä¹¦æœºå™¨äººWebhookï¼ˆéœ€æå‰æ·»åŠ åˆ°GitHub Secretsï¼Œå‘½åä¸ºFEISHU_WEBHOOKï¼‰
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          # Gitæ ¸å¿ƒä¿¡æ¯
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_ID: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          # éƒ¨ç½²ç›¸å…³ä¿¡æ¯
          SERVER_HOST: ${{ secrets.SERVER_SSH_HOST }}
          DOCKER_IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt3-app:latest
          # GitHub Actionæ—¥å¿—é“¾æ¥
          ACTION_LOG_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # æ ¼å¼åŒ–çŸ­æäº¤IDï¼ˆå¦‚ abc1234ï¼‰
          SHORT_COMMIT_ID=$(echo $COMMIT_ID | cut -c1-7)
          
          # ç»„è£…é£ä¹¦å¯Œæ–‡æœ¬æ¶ˆæ¯
          FEISHU_MSG=$(cat << EOF
          {
            "msg_type": "post",
            "content": {
              "post": {
                "zh_cn": {
                  "title": "âœ… Nuxt3 éƒ¨ç½²æˆåŠŸ | å®å¡”æœåŠ¡å™¨",
                  "content": [
                    [{"tag":"text","text":"ğŸ“‹ é¡¹ç›®ä¿¡æ¯ï¼š${REPO_NAME}"}],
                    [{"tag":"text","text":"ğŸŒ¿ éƒ¨ç½²åˆ†æ”¯ï¼š${BRANCH_NAME}"}],
                    [{"tag":"text","text":"ğŸ”– æäº¤ç‰ˆæœ¬ï¼š"},{"tag":"a","text":"${SHORT_COMMIT_ID}","href":"https://github.com/${REPO_NAME}/commit/${COMMIT_ID}"}],
                    [{"tag":"text","text":"âœï¸ æäº¤è€…ï¼š${COMMIT_AUTHOR} | æäº¤è¯´æ˜ï¼š${COMMIT_MSG}"}],
                    [{"tag":"text","text":"ğŸ–¥ï¸ éƒ¨ç½²æœåŠ¡å™¨ï¼š${SERVER_HOST}"}],
                    [{"tag":"text","text":"ğŸ³ é•œåƒç‰ˆæœ¬ï¼š${DOCKER_IMAGE}"}],
                    [{"tag":"text","text":"ğŸ“ éƒ¨ç½²æ—¥å¿—ï¼š"},{"tag":"a","text":"æŸ¥çœ‹GitHub Actionæ—¥å¿—","href":"${ACTION_LOG_URL}"}]
                  ]
                }
              }
            }
          }
          EOF
          )
          
          # æ¨é€æ¶ˆæ¯åˆ°é£ä¹¦
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$FEISHU_MSG" \
            $FEISHU_WEBHOOK