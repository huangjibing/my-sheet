# 工作流名称（宝塔适配版）
name: Nuxt Docker CI/CD (Baota)

# 触发条件：推送到main分支、手动触发
on:
  push:
    branches: [ master ]  # 替换为你的分支名（如master）
  workflow_dispatch:  # 允许手动触发

# 工作流任务
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # GitHub 官方Ubuntu虚拟机
    permissions:
      contents: read
      packages: write

    steps:
      # 步骤1：拉取GitHub仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：设置Docker构建环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤3：登录Docker Hub（镜像仓库）
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # 步骤4：构建并推送Docker镜像（适配Nuxt+宝塔）
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .  # 构建上下文（项目根目录）
          push: true  # 推送到镜像仓库
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt-sheet:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt-sheet:${{ github.sha }}
          # 构建优化：缓存依赖，加速构建
          cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/nuxt-sheet:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/nuxt-sheet:buildcache,mode=max

      # 步骤5：部署到宝塔服务器（核心适配宝塔）
      - name: Deploy to Baota Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          username: ${{ secrets.SERVER_SSH_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          # 超时时间（宝塔部署可能稍久）
          timeout: 120s
          # 宝塔专属部署脚本（解决权限/路径问题）
          script: |
            # 1. 进入宝塔项目目录
            cd ${{ secrets.SERVER_PROJECT_DIR }}
            
            # 2. 拉取最新镜像（root用户执行，避免权限问题）
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt-sheet:latest
            
            # 3. 停止并删除旧容器（容错：容器不存在时不报错）
            docker stop nuxt-docker-app || true
            docker rm nuxt-docker-app || true
            
            # 4. 启动新容器（适配宝塔：指定www用户、映射端口、权限）
            docker run -d \
              --name nuxt-docker-app \
              --user ${{ secrets.BAOTA_WWW_USER }} \  # 用宝塔www用户运行容器
              -p 3000:3000 \  # 宝塔已放行的端口（可改为80:3000）
              -v ${{ secrets.SERVER_PROJECT_DIR }}:/app \  # 挂载宝塔目录到容器
              --restart always \  # 容器异常自动重启（宝塔推荐）
              ${{ secrets.DOCKER_HUB_USERNAME }}/nuxt-sheet:latest
            
            # 5. 修复宝塔目录权限（关键：避免前端文件权限错误）
            chown -R ${{ secrets.BAOTA_WWW_USER }}:${{ secrets.BAOTA_WWW_USER }} ${{ secrets.SERVER_PROJECT_DIR }}
            
            # 6. 清理无用镜像（释放宝塔磁盘空间）
            docker system prune -f